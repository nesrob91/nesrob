/* * To change this license header, choose License Headers in Project Properties. * To change this template file, choose Tools | Templates * and open the template in the editor. */package com.elektra.paquetexpress;import java.io.ByteArrayOutputStream;import java.text.SimpleDateFormat;import java.util.Locale;import java.util.logging.Level;import java.util.logging.Logger;import javax.xml.bind.JAXBContext;import javax.xml.bind.JAXBException;import javax.xml.bind.Marshaller;import javax.xml.ws.BindingProvider;import com.elektra.beans.CredencialesTrackingPaquetexpress;import com.elektra.beans.DatosTracking;import com.elektra.beans.TrackingResponse;import com.elektra.dao.GeneralDao;import com.elektra.dao.GeneralDaoImpl;import com.elektra.dao.TrackingDao;import com.elektra.dao.TrackingDaoImpl;import com.paquetexpress.consultas.consultastatusguia.Data;import com.paquetexpress.consultas.consultastatusguia.Header;import com.paquetexpress.consultas.consultastatusguia.SolicitudEnvio;import com.paquetexpress.consultas.consultastatusguia.response.DataResponse;/** * * * * @author eaceves * */public class TrackingPaquetexpress {    TrackingDao trackingDao = new TrackingDaoImpl();    GeneralDao generalDao = new GeneralDaoImpl();    public TrackingResponse getTracking(DatosTracking datosTracking, CredencialesTrackingPaquetexpress credencialesTrackingPaquetexpress, String proxy) {        ByteArrayOutputStream in = new ByteArrayOutputStream();        SimpleDateFormat inFormat = new SimpleDateFormat("dd MMM yyyy", new Locale("es", "ES"));        SimpleDateFormat outFormat = new SimpleDateFormat("dd/MM/yyyy", new Locale("es", "ES"));        String fecha1 = "";        String request = "";        String response = "";        String ipProxy = proxy;                //String ipProxy = "10.50.8.21";        //System.setProperty("java.net.useSystemProxies", "true");        //System.setProperty("http.proxyUser", "ELEKTRA\\EACEVES");        //System.setProperty("http.proxyPassword", "Kiminodaisukidesupeach038");        System.setProperty("http.proxyHost", ipProxy);        System.setProperty("http.proxyPort", "8080");        TrackingResponse trackingResponse = new TrackingResponse();        try {            Header header = new Header();            header.setOrgnSystem(credencialesTrackingPaquetexpress.getOrgnSystem());            header.setAgreementKey(credencialesTrackingPaquetexpress.getAgreementKey());            header.setTypeEvent(credencialesTrackingPaquetexpress.getTypeEvent());                        SolicitudEnvio solicitudEnvio = new SolicitudEnvio();            solicitudEnvio.setNumRastreo(datosTracking.getNumGuia());                        Data data = new Data();            data.setHeader(header);            data.setSolicitudEnvio(solicitudEnvio);            DataResponse dataResponse = consultaStatusGuia(data);            JAXBContext jaxbContext;            try {                jaxbContext = JAXBContext.newInstance(Data.class);                Marshaller jaxbMarshaller = jaxbContext.createMarshaller();                jaxbMarshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);                in = new ByteArrayOutputStream();                jaxbMarshaller.marshal(data, in);                request = new String(in.toByteArray());                jaxbContext = JAXBContext.newInstance(DataResponse.class);                jaxbMarshaller = jaxbContext.createMarshaller();                jaxbMarshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);                in = new ByteArrayOutputStream();                jaxbMarshaller.marshal(dataResponse, in);                response = new String(in.toByteArray());            } catch (JAXBException ex) {                Logger.getLogger(TrackingPaquetexpress.class.getName()).log(Level.SEVERE, null, ex);            }            //System.out.println("\n\nrequest: " + request + "\n");            //System.out.println("\n\nresponse: " + response + "\n");            if (dataResponse.getRetornoSolicitud().getMensajes().getMensaje().get(0).getCveMsjeRetorno() != 0) {                if (dataResponse.getRetornoSolicitud().getMensajes().getMensaje().get(0).getDesMsjeRetorno().equals("NO SE ENCONTRÃ“ INFORMACION DE RASTREO")) {                    trackingResponse.setRefField1("DO NOTHING");                } else {                    trackingResponse.setIdEstatusGuia(-1);                    trackingResponse.setIdEstatusGuiaCarrier(null);                    trackingResponse.setRefField1(dataResponse.getRetornoSolicitud().getMensajes().getMensaje().get(0).getCveMsjeRetorno() + "");                    //trackingDao.insXml("-1", trackReply.getNotifications().get(0).getCode(), trackReply.getNotifications().get(0).getMessage(), request, response, datosTracking, "Tracking");                    generalDao.insXml("-1",                             dataResponse.getRetornoSolicitud().getMensajes().getMensaje().get(0).getCveMsjeRetorno() + "",                             dataResponse.getRetornoSolicitud().getMensajes().getMensaje().get(0).getDesMsjeRetorno(),                             request, response, datosTracking.getPedido(), datosTracking.getOrderId(), datosTracking.getCdId(),                             datosTracking.getIdCarrier(), "Tracking Paquetexpress", datosTracking.getRef_field_2());                }            } else {                for (int i = 0; i < dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().size(); i++) {                    if (dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().get(i).getClaveDataAd().equals("statusId")) {                        trackingResponse.setIdEstatusGuiaCarrier(dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().get(i).getValorDataAd());                        trackingResponse.setIdEstatusGuia(trackingDao.getIdEstatusGuia(datosTracking.getIdCarrier(), dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().get(i).getValorDataAd()));                        if (trackingResponse.getIdEstatusGuiaCarrier().equals("OTN") || trackingResponse.getIdEstatusGuiaCarrier().equals("TRN") || trackingResponse.getIdEstatusGuiaCarrier().equals("HCA")                                || trackingResponse.getIdEstatusGuiaCarrier().equals("WHU") || trackingResponse.getIdEstatusGuiaCarrier().equals("IIM") || trackingResponse.getIdEstatusGuiaCarrier().equals("HCM")                                || trackingResponse.getIdEstatusGuiaCarrier().equals("HTC")) {                            trackingResponse.setRecibe(dataResponse.getRetornoSolicitud().getStatus().toUpperCase());                        }                        if (!trackingResponse.getIdEstatusGuiaCarrier().equals("HDC") && !trackingResponse.getIdEstatusGuiaCarrier().equals("OTN") && !trackingResponse.getIdEstatusGuiaCarrier().equals("BDL") && !trackingResponse.getIdEstatusGuiaCarrier().equals("HCA")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("WHU")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("TRN")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("IIM")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("HCM")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("HTC")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("SWB")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("RRA")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("HDR")                                && !trackingResponse.getIdEstatusGuiaCarrier().equals("RTA")) {                            System.out.println("ESTATUS");                        }                    }                }                if (trackingResponse.getIdEstatusGuia() == 30) {                    int opc = dataResponse.getRetornoSolicitud().getStatus().lastIndexOf(",");                    int opc2 = dataResponse.getRetornoSolicitud().getStatus().length();                    if (dataResponse.getRetornoSolicitud().getStatus().lastIndexOf(",") + 1 != dataResponse.getRetornoSolicitud().getStatus().length()) {                        trackingResponse.setRecibe(dataResponse.getRetornoSolicitud().getStatus().substring(dataResponse.getRetornoSolicitud().getStatus().lastIndexOf(",") + 10).toUpperCase());                    } else {                        trackingResponse.setRecibe(dataResponse.getRetornoSolicitud().getStatus().substring(dataResponse.getRetornoSolicitud().getStatus().indexOf(",") + 10).toUpperCase());                    }                    for (int i = 0; i < dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().size(); i++) {                        if (dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().get(i).getClaveDataAd().equals("fechaEntrega")) {                            trackingResponse.setFechaRecepcion(dataResponse.getRetornoSolicitud().getDatosAdicionales().getDatoAdicional().get(i).getValorDataAd());                        }                    }                }                if (trackingResponse.getIdEstatusGuia() == 20) {                    try {                        fecha1 = dataResponse.getRetornoSolicitud().getFecha().replace("del", "").replace("de", "").replace("  ", " ").toLowerCase();                        trackingResponse.setFechaRecoleccion(outFormat.format(inFormat.parse(fecha1)) + " " + dataResponse.getRetornoSolicitud().getHora().replace(" horas", ""));                    } catch (Exception ex) {                        System.out.println(ex.getMessage());                    }                }                trackingResponse.setRefField1(null);                /*                if () {diego                     trackingResponse.setIdEstatusGuia(trackingDao.getIdEstatusGuia(datosTracking.getIdCarrier(), trackReply.getCompletedTrackDetails().get(0).getTrackDetails().get(0).getStatusDetail().getCode()));                    trackingResponse.setIdEstatusGuiaCarrier(trackReply.getCompletedTrackDetails().get(0).getTrackDetails().get(0).getStatusDetail().getCode());                    trackingResponse.setRefField1(null);                } else if (1 != 2) {                    // DO NOTHING                    trackingResponse.setIdEstatusGuia(0);                    trackingResponse.setIdEstatusGuiaCarrier(trackReply.getCompletedTrackDetails().get(0).getTrackDetails().get(0).getNotification().getCode());                    trackingResponse.setRefField1("DO NOTHING");                } else {                    trackingResponse.setIdEstatusGuia(-1);                    trackingResponse.setIdEstatusGuiaCarrier(null);                    trackingResponse.setRefField1(error);                    //trackingDao.insXml("-1", trackReply.getCompletedTrackDetails().get(0).getTrackDetails().get(0).getNotification().getCode(), trackReply.getCompletedTrackDetails().get(0).getTrackDetails().get(0).getNotification().getMessage(), request, response, datosTracking, "Tracking");                    generalDao.insXml("-1", error, error, request, response, datosTracking.getPedido(), datosTracking.getOrderId(), datosTracking.getCdId(), datosTracking.getIdCarrier(), "Tracking Paquetexpress");                }*/            }        } catch (Exception e) {            trackingResponse.setIdEstatusGuia(-1);            trackingResponse.setIdEstatusGuiaCarrier(null);            trackingResponse.setRefField1(e.toString());            generalDao.insXml("-1", datosTracking.getNumGuia(), trackingResponse.getRefField1(), trackingResponse.getInput(), trackingResponse.getOutput(), datosTracking.getPedido(), datosTracking.getOrderId(), datosTracking.getCdId(), datosTracking.getIdCarrier(), "Tracking PaqueteExpress", datosTracking.getRef_field_2());        }        return trackingResponse;    }    private static DataResponse consultaStatusGuia(com.paquetexpress.consultas.consultastatusguia.Data parameters) {        com.paquetexpress.consultas.consultastatusguia.Consultas_Service service = new com.paquetexpress.consultas.consultastatusguia.Consultas_Service();        com.paquetexpress.consultas.consultastatusguia.Consultas port = service.getConsultasSOAP();        //PROD        String endpointURL = "http://webbooking.paquetexpress.mx:8104/wsPaquetexpressGestor/services/consultasSOAP";        //http://webbooking.paquetexpress.mx:8104/wsPaquetexpressGestor/services/consultasSOAP        BindingProvider bp = (BindingProvider) port;        bp.getRequestContext().put(BindingProvider.ENDPOINT_ADDRESS_PROPERTY, endpointURL);        return port.consultaStatusGuia(parameters);    }}